<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-08-05 Wed 11:14 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PX4 and ROS Programming Day 1</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Donghee Park" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<style type="text/css">img {  width: auto ;  max-width: 100% ;  height: auto ;} </style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "left",
        displayIndent: "5em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "Neo-Euler"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "Neo-Euler"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "left",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">PX4 and ROS Programming Day 1</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0e63264">1. 수업</a></li>
<li><a href="#org329c00e">2. 드론 제어 소프트웨어 소개 및 설치</a></li>
<li><a href="#org2bd4a31">3. PX4 소개</a>
<ul>
<li><a href="#orgb1a6b4e">3.1. PX4 미들웨어 및 앱 구조 소개</a></li>
</ul>
</li>
<li><a href="#org06ffd8d">4. Linux 사용하기</a></li>
<li><a href="#orgac36e9d">5. PX4 개발환경 구성 (+ROS)</a></li>
<li><a href="#org3a5a41e">6. PX4 Firmware Build</a>
<ul>
<li><a href="#org5df324c">6.1. PX4 v.10.1 다운로드</a></li>
<li><a href="#org05aac33">6.2. Gazebo 실행</a></li>
<li><a href="#org55166b2">6.3. QGroundControl 사용</a></li>
</ul>
</li>
<li><a href="#org3ffdf42">7. ROS 프로그래밍</a>
<ul>
<li><a href="#orgd53443d">7.1. ROS</a></li>
<li><a href="#org496fdb8">7.2. ROS Nodes and Topics</a>
<ul>
<li><a href="#orgc6cd159">7.2.1. ROS Master Process</a></li>
<li><a href="#org324ff87">7.2.2. Topics</a></li>
<li><a href="#org2aa44a9">7.2.3. Publish and Subscribe</a></li>
</ul>
</li>
<li><a href="#org2b016b1">7.3. ROS Message Passing</a></li>
<li><a href="#org0c2700f">7.4. ROS Services</a>
<ul>
<li><a href="#org09b00f6">7.4.1. 예시: 카메라 이미지 얻기</a></li>
</ul>
</li>
<li><a href="#org9d53d12">7.5. ROS Turtlesim</a>
<ul>
<li><a href="#org8674c69">7.5.1. Turtlesim 실행하기</a></li>
<li><a href="#org69a4c66">7.5.2. Turtlesim 노드 목록</a></li>
<li><a href="#orgd33ad62">7.5.3. Turtlesim 토픽 목록</a></li>
<li><a href="#org09e8f49">7.5.4. Turtlesim 토픽 정보</a></li>
<li><a href="#orgdbff879">7.5.5. Turtlesim 메시지 정보</a></li>
<li><a href="#org6421af5">7.5.6. Turtlesim Echo a Topic</a></li>
<li><a href="#org20e3a51">7.5.7. <code>rqt_graph</code></a></li>
</ul>
</li>
<li><a href="#orgcac8205">7.6. MavROS</a>
<ul>
<li><a href="#orgc1c5fcf">7.6.1. MavROS 설치 및 실행 (이미 자동설치됨, 안해도됨)</a></li>
</ul>
</li>
<li><a href="#org30bc863">7.7. Gazebo 실행</a></li>
</ul>
</li>
<li><a href="#org96a5c0b">8. ROS 노드 관리</a>
<ul>
<li><a href="#org8f3e037">8.1. ROS 노드 실행 및 관리</a></li>
<li><a href="#org84e8008">8.2. ROS 노드 토픽 명령 실행하기. (MAVROS 위주)</a>
<ul>
<li><a href="#orga1a8bb2">8.2.1. Subscribe</a></li>
<li><a href="#org250ba6c">8.2.2. Services</a></li>
<li><a href="#orge254c6c">8.2.3. Publish</a></li>
<li><a href="#org4fec7c5">8.2.4. 실습</a></li>
<li><a href="#org0f2154d">8.2.5. 유용한 mavros 명령(노드) 모음</a></li>
</ul>
</li>
<li><a href="#org4c12087">8.3. 토픽 레코드: rosbag</a></li>
<li><a href="#org2ddd5db">8.4. 참고</a></li>
</ul>
</li>
<li><a href="#org41d0eb8">9. ROS 노드 만들기</a>
<ul>
<li><a href="#org6a72cf2">9.1. 새로운 노드 만들기</a>
<ul>
<li><a href="#orgaf9ae3d">9.1.1. 패키지 만들기</a></li>
<li><a href="#org84c12dd">9.1.2. 노드 코드 작성</a></li>
<li><a href="#org70fe06c">9.1.3. 패키지 빌드</a></li>
<li><a href="#org91125e7">9.1.4. 패키지 노드 실행</a></li>
<li><a href="#org5a913d4">9.1.5. 해보기: /mavros/state 읽어서 1초마다 비행 mode 한번씩 출력</a></li>
<li><a href="#orgc2a4f63">9.1.6. 해보기 결과:</a></li>
</ul>
</li>
<li><a href="#org0d52d21">9.2. 새로운 노드 만들기: 드론 이륙 착륙</a></li>
<li><a href="#org1dbc90f">9.3. 새로운 노드 만들기: <code>offb_node</code></a>
<ul>
<li><a href="#org1e9ef3a">9.3.1. launch 파일을 이용하여 노드 한번에 실행 (옵션)</a></li>
</ul>
</li>
<li><a href="#org5489a94">9.4. 새로운 노드 만들기: <code>circle</code></a>
<ul>
<li><a href="#orgf0cc9a5">9.4.1. 해보기: 원의 너비와 속도를 바꾸어 보자. 힌트 (wn, r)</a></li>
</ul>
</li>
<li><a href="#org7c0416a">9.5. 과제: 키보드로 OFFBOARD 모드 제어하기</a></li>
<li><a href="#orge3ea0e3">9.6. 참고</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0e63264" class="outline-2">
<h2 id="org0e63264"><span class="section-number-2">1</span> 수업</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>목표: 드론 제어 소프트웨어에 대해 이해할 수 있고, 프로그래밍 환경을 구축할 수 있다.</li>
<li>교재: <a href="https://learn.dronemap.io/">https://learn.dronemap.io/</a></li>
<li>코치: 박동희 dongheepark@gmail.com</li>
</ul>
</div>
</div>

<div id="outline-container-org329c00e" class="outline-2">
<h2 id="org329c00e"><span class="section-number-2">2</span> 드론 제어 소프트웨어 소개 및 설치</h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li>워크숍 소개, 참가자 소개</li>

<li>PX4 소개, ROS 소개</li>

<li>Linux 사용하기</li>
</ol>
</div>
</div>

<div id="outline-container-org2bd4a31" class="outline-2">
<h2 id="org2bd4a31"><span class="section-number-2">3</span> PX4 소개</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><a href="https://px4.io/">https://px4.io/</a>
<ul class="org-ul">
<li>Pixhawk</li>
<li>PX4 Firmware</li>
<li>Mavlink</li>
<li>QGroundControl</li>
</ul></li>
<li><a href="https://learn.dronemap.io/px4-workbook/px4-intro.html">https://learn.dronemap.io/px4-workbook/px4-intro.html</a>
<ul class="org-ul">
<li>소프트웨어 아키텍처</li>
<li>시뮬레이터 포트 구성</li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgb1a6b4e" class="outline-3">
<h3 id="orgb1a6b4e"><span class="section-number-3">3.1</span> PX4 미들웨어 및 앱 구조 소개</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>디렉토리 구조 소개</li>
<li>uORB</li>
<li>PX4 shell 사용하기</li>
<li>hello-skyworld</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org06ffd8d" class="outline-2">
<h2 id="org06ffd8d"><span class="section-number-2">4</span> Linux 사용하기</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Ubuntu 18.04 설치</li>
<li>주요 명령어 소개(파일 조작, 프로그램설치, 쉘스크립트, git)</li>
</ul>

<p>
ls: 파일 또는 디렉토리의 목록을 출력
</p>
<pre class="example">
ls
ls -al
</pre>

<p>
cd: 디렉토리 이동
</p>
<pre class="example">
cd ~
cd ~/Downloads
</pre>

<p>
pwd: 현재 디렉토리 출력
</p>
<pre class="example">
pwd
</pre>

<p>
mkdir: 디렉토리 생성
</p>
<pre class="example">
mkdir tmp
</pre>

<p>
rm: 파일 또는 디렉토리 지우기
</p>
<pre class="example">
rm -rf tmp
</pre>

<p>
cat: 파일 입력 또는 출력
</p>
<pre class="example">
cat ~/.bashrc
cat &gt; ~/.hello.c
</pre>

<p>
cp: 파일 또는 디렉토리 복사
</p>
<pre class="example">
cp hello.c world.c
</pre>

<p>
chmod: 파일의 퍼미션 지정
</p>
<pre class="example">
chmod +x hello
</pre>

<p>
wget: url에서 파일 다운로드
</p>
<pre class="example">
wget https://google.com
</pre>

<p>
source: 현재 쉘에서 파일을 읽고 실행
</p>
<pre class="example">
source ~/.bashrc
</pre>
</div>
</div>


<div id="outline-container-orgac36e9d" class="outline-2">
<h2 id="orgac36e9d"><span class="section-number-2">5</span> PX4 개발환경 구성 (+ROS)</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="https://dev.px4.io/master/en/setup/dev_env_linux_ubuntu.html">https://dev.px4.io/master/en/setup/dev_env_linux_ubuntu.html</a>
</p>

<pre class="example">
cd ~
wget https://raw.githubusercontent.com/PX4/Devguide/master/build_scripts/ubuntu_sim_ros_melodic.sh
chmod +x ubuntu_sim_ros_melodic.sh
./ubuntu_sim_ros_melodic.sh
</pre>
</div>
</div>

<div id="outline-container-org3a5a41e" class="outline-2">
<h2 id="org3a5a41e"><span class="section-number-2">6</span> PX4 Firmware Build</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><a href="https://dev.px4.io">https://dev.px4.io</a></li>
<li>Gazebo 사용하기</li>
<li>Qgroundcontrol</li>
</ul>
</div>

<div id="outline-container-org5df324c" class="outline-3">
<h3 id="org5df324c"><span class="section-number-3">6.1</span> PX4 v.10.1 다운로드</h3>
<div class="outline-text-3" id="text-6-1">
<pre class="example">
cd ~
git clone https://github.com/PX4/Firmware.git --recursive
cd ~/Firmware
bash ./Tools/setup/ubuntu.sh
git checkout v1.10.1
git submodule update --init --recursive
</pre>
</div>
</div>

<div id="outline-container-org05aac33" class="outline-3">
<h3 id="org05aac33"><span class="section-number-3">6.2</span> Gazebo 실행</h3>
<div class="outline-text-3" id="text-6-2">
<pre class="example">
cd ~/Firmware
make px4_sitl gazebo
</pre>
</div>
</div>

<div id="outline-container-org55166b2" class="outline-3">
<h3 id="org55166b2"><span class="section-number-3">6.3</span> QGroundControl 사용</h3>
<div class="outline-text-3" id="text-6-3">
<p>
다운로드: <a href="https://docs.qgroundcontrol.com/en/getting_started/download_and_install.html">https://docs.qgroundcontrol.com/en/getting_started/download_and_install.html</a>
</p>

<p>
QGroundControl 다운로드 및 실행
</p>
<pre class="example">
sudo usermod -a -G dialout $USER
sudo apt-get remove modemmanager -y
sudo apt install gstreamer1.0-plugins-bad gstreamer1.0-libav gstreamer1.0-gl -y

cd ~/Downloads
chmod +x ./QGroundControl.AppImage
./QGroundControl.AppImage
</pre>
</div>
</div>
</div>


<div id="outline-container-org3ffdf42" class="outline-2">
<h2 id="org3ffdf42"><span class="section-number-2">7</span> ROS 프로그래밍</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgd53443d" class="outline-3">
<h3 id="orgd53443d"><span class="section-number-3">7.1</span> ROS</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Robot Operating System: 로봇 빌드에 사용되는 라이브러리 어플리케이션 모음 <a href="http://www.ros.org/">http://www.ros.org/</a></li>
<li>목표: 로봇을 만들때 기존의 재활용 하고 공유하자.</li>
<li>History:
<ul class="org-ul">
<li>2000s: Standford Artificial intelligence</li>
<li>2007: Willow Garage</li>
<li>2013: Open Source Robotics Foundation</li>
</ul></li>
<li>사용 분야: Drone, Kinematic ARMS(로봇암), Wheeled(바퀴), Bi-pedal(이족)</li>
</ul>
</div>
</div>

<div id="outline-container-org496fdb8" class="outline-3">
<h3 id="org496fdb8"><span class="section-number-3">7.2</span> ROS Nodes and Topics</h3>
<div class="outline-text-3" id="text-7-2">

<div class="figure">
<p><img src="ros_nodes_and_topics1.png" alt="ros_nodes_and_topics1.png" />
</p>
</div>
</div>

<ol class="org-ol">
<li><a id="orgd1ed42d"></a>Perception: Sense<br />
<div class="outline-text-5" id="text-7-2-0-1">
<ul class="org-ul">
<li>Sensor Fusion</li>
<li>Filtering</li>
<li>Localization</li>
</ul>
</div>
</li>

<li><a id="org56f65b6"></a>Dicesion Making: Decide<br />
<div class="outline-text-5" id="text-7-2-0-2">
<ul class="org-ul">
<li>Path Planning</li>
<li>Prediction</li>
<li>Behavior Planning</li>
</ul>
</div>
</li>

<li><a id="org2754a02"></a>Actuation: Act<br />
<div class="outline-text-5" id="text-7-2-0-3">
<ul class="org-ul">
<li>PID Control</li>
<li>Model Predictive Control</li>
</ul>
</div>
</li>
</ol>

<div id="outline-container-orgc6cd159" class="outline-4">
<h4 id="orgc6cd159"><span class="section-number-4">7.2.1</span> ROS Master Process</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
노드 관리
</p>


<div class="figure">
<p><img src="ros_master_process1.png" alt="ros_master_process1.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org324ff87" class="outline-4">
<h4 id="org324ff87"><span class="section-number-4">7.2.2</span> Topics</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
노드간 통신 인터페이스. 구독 발행의 이름
</p>


<div class="figure">
<p><img src="ros_topic1.png" alt="ros_topic1.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org2aa44a9" class="outline-4">
<h4 id="org2aa44a9"><span class="section-number-4">7.2.3</span> Publish and Subscribe</h4>
<div class="outline-text-4" id="text-7-2-3">
<p>
발행과 구독. 신문/잡지 발행 구독에 비유
</p>


<div class="figure">
<p><img src="ros_publish_and_subscribe1.png" alt="ros_publish_and_subscribe1.png" />
</p>
</div>

<p>
실제 예제
</p>


<div class="figure">
<p><img src="ros_publish_and_subscribe2.png" alt="ros_publish_and_subscribe2.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org2b016b1" class="outline-3">
<h3 id="org2b016b1"><span class="section-number-3">7.3</span> ROS Message Passing</h3>
<div class="outline-text-3" id="text-7-3">
<p>
메시지: 노드간 통신할때 이동하는 실제 데이터
</p>
<ul class="org-ul">
<li>메시지는 텍스트로 구성. 메시지를 이해하기 쉽다.</li>
</ul>

<p>
미리 정의된 메시지 타입 :
</p>
<ul class="org-ul">
<li><a href="http://wiki.ros.org/common_msgs">http://wiki.ros.org/common_msgs</a></li>
<li><a href="https://github.com/ros/common_msgs">https://github.com/ros/common_msgs</a></li>
</ul>
</div>
</div>

<div id="outline-container-org0c2700f" class="outline-3">
<h3 id="org0c2700f"><span class="section-number-3">7.4</span> ROS Services</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>Request-Response, 1:1 통신</li>
<li>PubSub이 필요 없는 경우 사용, 요청 할때만 데이터가 제공. 네트워크 부하가 적다.</li>
</ul>
</div>

<div id="outline-container-org09b00f6" class="outline-4">
<h4 id="org09b00f6"><span class="section-number-4">7.4.1</span> 예시: 카메라 이미지 얻기</h4>
<div class="outline-text-4" id="text-7-4-1">

<div class="figure">
<p><img src="ros_services1.png" alt="ros_services1.png" />
</p>
</div>


<div class="figure">
<p><img src="ros_services2.png" alt="ros_services2.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org9d53d12" class="outline-3">
<h3 id="org9d53d12"><span class="section-number-3">7.5</span> ROS Turtlesim</h3>
<div class="outline-text-3" id="text-7-5">
<p>
Turtle
</p>


<div class="figure">
<p><img src="https://i.imgur.com/0r46gFH.png" alt="0r46gFH.png" />
</p>
</div>
</div>

<div id="outline-container-org8674c69" class="outline-4">
<h4 id="org8674c69"><span class="section-number-4">7.5.1</span> Turtlesim 실행하기</h4>
<div class="outline-text-4" id="text-7-5-1">

<div class="figure">
<p><img src="https://d17h27t6h515a5.cloudfront.net/topher/2017/March/58d9820b_running-turtlesim/running-turtlesim.png" alt="running-turtlesim.png" />
</p>
</div>


<ol class="org-ol">
<li>환경 변수 설정</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">$ source /opt/ros/melodic/setup.bash
</pre>
</div>

<ol class="org-ol">
<li>roscore 실행
<ul class="org-ul">
<li>roscore: Master + rosout + parameter server
<ul class="org-ul">
<li>Master: 네임 서비스</li>
<li>rosout: stdout/stderr 로깅</li>
<li>parameter server: 파라미터 저장 서버</li>
</ul></li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">$ roscore
</pre>
</div>

<ol class="org-ol">
<li>turtlesim 패키지의 turtlesim<sub>node</sub> 실행</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh">$ rosrun turtlesim turtlesim_node
</pre>
</div>

<ol class="org-ol">
<li>turtlesim 패키지의 turtle<sub>teleop</sub><sub>key</sub> 실행</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh">rosrun turtlesim turtle_teleop_key
</pre>
</div>
</div>
</div>

<div id="outline-container-org69a4c66" class="outline-4">
<h4 id="org69a4c66"><span class="section-number-4">7.5.2</span> Turtlesim 노드 목록</h4>
<div class="outline-text-4" id="text-7-5-2">
<div class="org-src-container">
<pre class="src src-sh">rosnode list
</pre>
</div>

<p>
/rosout : ROS 메시지 로깅.
</p>
</div>
</div>

<div id="outline-container-orgd33ad62" class="outline-4">
<h4 id="orgd33ad62"><span class="section-number-4">7.5.3</span> Turtlesim 토픽 목록</h4>
<div class="outline-text-4" id="text-7-5-3">
<div class="org-src-container">
<pre class="src src-sh">rostopic list
</pre>
</div>
</div>
</div>

<div id="outline-container-org09e8f49" class="outline-4">
<h4 id="org09e8f49"><span class="section-number-4">7.5.4</span> Turtlesim 토픽 정보</h4>
<div class="outline-text-4" id="text-7-5-4">
<div class="org-src-container">
<pre class="src src-sh">rostopic info /turtle1/cmd_vel

</pre>
</div>
</div>
</div>

<div id="outline-container-orgdbff879" class="outline-4">
<h4 id="orgdbff879"><span class="section-number-4">7.5.5</span> Turtlesim 메시지 정보</h4>
<div class="outline-text-4" id="text-7-5-5">
<div class="org-src-container">
<pre class="src src-sh">$ rosmsg info geometry_msgs/Twist
geometry_msgs/Vector3 linear
  float64 x
  float64 y
  float64 z
geometry_msgs/Vector3 angular
  float64 x
  float64 y
  float64 z
</pre>
</div>

<p>
or
</p>

<div class="org-src-container">
<pre class="src src-sh">rosed geometry_msgs Twist.msg
</pre>
</div>
</div>
</div>

<div id="outline-container-org6421af5" class="outline-4">
<h4 id="org6421af5"><span class="section-number-4">7.5.6</span> Turtlesim Echo a Topic</h4>
<div class="outline-text-4" id="text-7-5-6">
<p>
디버깅시 편리
</p>

<div class="org-src-container">
<pre class="src src-sh">rostopic echo /turtle1/cmd_vel
</pre>
</div>
</div>
</div>

<div id="outline-container-org20e3a51" class="outline-4">
<h4 id="org20e3a51"><span class="section-number-4">7.5.7</span> <code>rqt_graph</code></h4>
<div class="outline-text-4" id="text-7-5-7">
<div class="org-src-container">
<pre class="src src-sh">rqt_graph
</pre>
</div>


<div class="figure">
<p><img src="http://wiki.ros.org/rqt_graph?action=AttachFile&amp;do=get&amp;target=snap_rqt_graph_moveit_demo.png" alt="rqt_graph?action=AttachFile&amp;do=get&amp;target=snap_rqt_graph_moveit_demo.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcac8205" class="outline-3">
<h3 id="orgcac8205"><span class="section-number-3">7.6</span> MavROS</h3>
<div class="outline-text-3" id="text-7-6">
<p>
<a href="http://wiki.ros.org/mavros">http://wiki.ros.org/mavros</a> mavlink ros wrapper
</p>


<div class="figure">
<p><img src="https://i.imgur.com/9z8DEIn.png" alt="9z8DEIn.png" />
</p>
</div>
</div>

<div id="outline-container-orgc1c5fcf" class="outline-4">
<h4 id="orgc1c5fcf"><span class="section-number-4">7.6.1</span> MavROS 설치 및 실행 (이미 자동설치됨, 안해도됨)</h4>
<div class="outline-text-4" id="text-7-6-1">
<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #579C4C;">## </span><span style="color: #579C4C;">Create catkin workspace (ROS build system)</span>
mkdir -p ~/catkin_ws/src
<span style="color: #C586C0;">cd</span> ~/catkin_ws

<span style="color: #579C4C;">## </span><span style="color: #579C4C;">Install dependencies</span>
sudo apt-get install python-wstool python-rosinstall-generator python-catkin-tools -y

<span style="color: #579C4C;">## </span><span style="color: #579C4C;">Initialise wstool</span>
wstool init ~/catkin_ws/src

<span style="color: #579C4C;">## </span><span style="color: #579C4C;">Build MAVROS</span>
<span style="color: #579C4C;">### </span><span style="color: #579C4C;">Get source (upstream - released)</span>
rosinstall_generator --upstream mavros --rosdistro kinetic | tee /tmp/mavros.rosinstall
<span style="color: #579C4C;">### </span><span style="color: #579C4C;">Get latest released mavlink package</span>
rosinstall_generator mavlink --rosdistro kinetic | tee -a /tmp/mavros.rosinstall
<span style="color: #579C4C;">### </span><span style="color: #579C4C;">Setup workspace &amp; install deps</span>
wstool merge -t src /tmp/mavros.rosinstall
wstool update -t src
rosdep install --from-paths src --ignore-src --rosdistro kinetic -y

<span style="color: #579C4C;">### </span><span style="color: #579C4C;">Install GeographicLib datasets</span>
./src/mavros/mavros/scripts/install_geographiclib_datasets.sh

<span style="color: #579C4C;">### </span><span style="color: #579C4C;">Build source</span>
catkin build

<span style="color: #579C4C;">### </span><span style="color: #579C4C;">source setup.bash</span>
<span style="color: #C586C0;">source</span> devel/setup.bash

</pre>
</div>

<p>
환경변수 설정: workspace
</p>

<pre class="example">
cd ~/catkin_ws
source devel/setup.bash
</pre>

<p>
<code>mavros_node</code> 실행
</p>

<div class="org-src-container">
<pre class="src src-sh">rosrun mavros mavros_node _fcu_url:=<span style="color: #DB8E73;">"udp://:14540@127.0.0.1:14557"</span> _gcs_url:=<span style="color: #DB8E73;">"udp://@127.0.0.1"</span>
</pre>
</div>

<p>
<code>mavros_node</code> 실행 (다른 방법)
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #579C4C;"># </span><span style="color: #579C4C;">px4.launch &#51060;&#50857;&#54616;&#50668; mavros node &#49892;&#54665;. fcu ip&#51452;&#49548;&#45716; 192.168.0.xxx</span>
roslaunch mavros px4.launch fcu_url:=<span style="color: #DB8E73;">"udp://:14540@192.168.0.xxx:14557"</span> _gcs_url:<span style="color: #DB8E73;">"udp://@127.0.0.1"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org30bc863" class="outline-3">
<h3 id="org30bc863"><span class="section-number-3">7.7</span> Gazebo 실행</h3>
<div class="outline-text-3" id="text-7-7">
<p>
시뮬레이터의 홈 위치(위도 경도 해발고도) 지정
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #C586C0;">export</span> <span style="color: #85DDFF;">PX4_HOME_LAT</span>=35.9012382
<span style="color: #C586C0;">export</span> <span style="color: #85DDFF;">PX4_HOME_LON</span>=128.854495337
<span style="color: #C586C0;">export</span> <span style="color: #85DDFF;">PX4_HOME_ALT</span>=71

make posix_sitl gazebo
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org96a5c0b" class="outline-2">
<h2 id="org96a5c0b"><span class="section-number-2">8</span> ROS 노드 관리</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org8f3e037" class="outline-3">
<h3 id="org8f3e037"><span class="section-number-3">8.1</span> ROS 노드 실행 및 관리</h3>
<div class="outline-text-3" id="text-8-1">
</div>
<ol class="org-ol">
<li><a id="org687328c"></a>ROS Core 노드 실행<br />
<div class="outline-text-5" id="text-8-1-0-1">
<div class="org-src-container">
<pre class="src src-sh">$ roscore
</pre>
</div>
</div>
</li>

<li><a id="orgfc6eb46"></a>MAVROS 노드 실행<br />
<div class="outline-text-5" id="text-8-1-0-2">
<div class="org-src-container">
<pre class="src src-sh">$ roslaunch mavros px4.launch

<span style="color: #579C4C;"># </span><span style="color: #579C4C;">roslaunch mavros px4.launch fcu_url:="udp://:14540@192.168.88.53:14557" gcs_url:="udp://@192.168.88.53"</span>
<span style="color: #579C4C;"># </span><span style="color: #579C4C;">roslaunch mavros px4.launch fcu_url:="/dev/ttyTHS1:921600" gcs_url:="udp://@192.168.88.53"</span>
</pre>
</div>
</div>
</li>

<li><a id="orgc100eed"></a>토픽 목록<br />
<div class="outline-text-5" id="text-8-1-0-3">
<div class="org-src-container">
<pre class="src src-sh">$ rostopic list
</pre>
</div>
</div>
</li>

<li><a id="org1953f7b"></a>토픽 내용 보기<br />
<ol class="org-ol">
<li><a id="org29a3b44"></a>메시지 타입 보기<br />
<div class="outline-text-6" id="text-8-1-0-4-1">
<div class="org-src-container">
<pre class="src src-sh">$ rostopic info /mavros/state
</pre>
</div>

<p>
타입 내부 보기
</p>
<div class="org-src-container">
<pre class="src src-sh">rostopic type /mavros/state | rosmsg show
</pre>
</div>
</div>
</li>

<li><a id="orgfbbdf87"></a>메시지 내용<br />
<div class="outline-text-6" id="text-8-1-0-4-2">
<div class="org-src-container">
<pre class="src src-sh">$ rostopic echo /mavros/state
</pre>
</div>
</div>
</li>

<li><a id="orgc1b39cd"></a>토픽 publish 주기 보기<br />
<div class="outline-text-6" id="text-8-1-0-4-3">
<div class="org-src-container">
<pre class="src src-sh">$ rostopic hz /mavros/state
</pre>
</div>
</div>
</li>

<li><a id="orgfca9369"></a>실행 노드 확인<br />
<div class="outline-text-6" id="text-8-1-0-4-4">
<div class="org-src-container">
<pre class="src src-sh">$ rqt_graph
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-org84e8008" class="outline-3">
<h3 id="org84e8008"><span class="section-number-3">8.2</span> ROS 노드 토픽 명령 실행하기. (MAVROS 위주)</h3>
<div class="outline-text-3" id="text-8-2">
<p>
<a href="http://wiki.ros.org/ROS/Tutorials/UnderstandingTopics">http://wiki.ros.org/ROS/Tutorials/UnderstandingTopics</a>
</p>
</div>

<div id="outline-container-orga1a8bb2" class="outline-4">
<h4 id="orga1a8bb2"><span class="section-number-4">8.2.1</span> Subscribe</h4>
<div class="outline-text-4" id="text-8-2-1">
<div class="org-src-container">
<pre class="src src-sh">rostopic echo [topic]
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org1137fb0"></a><code>STATE</code><br />
<div class="outline-text-5" id="text-8-2-1-1">
<div class="org-src-container">
<pre class="src src-sh">$ rostopic echo /mavros/state
</pre>
</div>
</div>
</li>

<li><a id="orgafcf355"></a><code>LOCAL_POSITION</code> 확인<br />
<div class="outline-text-5" id="text-8-2-1-2">
<div class="org-src-container">
<pre class="src src-sh">$ rostopic echo /mavros/local_position/pose
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org250ba6c" class="outline-4">
<h4 id="org250ba6c"><span class="section-number-4">8.2.2</span> Services</h4>
<div class="outline-text-4" id="text-8-2-2">
<div class="org-src-container">
<pre class="src src-sh">rosservice call [topic] [msg_type] [args]
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgd75d215"></a><code>SET_MODE</code><br />
<div class="outline-text-5" id="text-8-2-2-1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #579C4C;"># </span><span style="color: #579C4C;">https://github.com/mavlink/mavros/blob/master/mavros_msgs/srv/SetMode.srv</span>
<span style="color: #579C4C;"># </span><span style="color: #579C4C;">http://wiki.ros.org/mavros/CustomModes</span>
<span style="color: #579C4C;"># </span><span style="color: #579C4C;">Manual Mode</span>
rosservice call /mavros/set_mode <span style="color: #DB8E73;">"base_mode: 64</span>
<span style="color: #DB8E73;">custom_mode: ''"</span>

rosservice call /mavros/set_mode <span style="color: #DB8E73;">"base_mode: 0</span>
<span style="color: #DB8E73;">custom_mode: 'MANUAL'"</span>

rosservice call /mavros/set_mode <span style="color: #DB8E73;">"base_mode: 0</span>
<span style="color: #DB8E73;">custom_mode: 'POSCTL'"</span>

rosservice call /mavros/set_mode <span style="color: #DB8E73;">"base_mode: 0</span>
<span style="color: #DB8E73;">custom_mode: 'OFFBOARD'"</span>

rosservice call /mavros/set_mode <span style="color: #DB8E73;">"base_mode: 0</span>
<span style="color: #DB8E73;">custom_mode: 'AUTO.LAND'"</span>
</pre>
</div>
</div>
</li>

<li><a id="org7083d23"></a><code>ARMING</code><br />
<div class="outline-text-5" id="text-8-2-2-2">
<div class="org-src-container">
<pre class="src src-sh">rosservice call /mavros/cmd/arming <span style="color: #DB8E73;">"value: true"</span>
</pre>
</div>
</div>
</li>

<li><a id="org49bd533"></a><code>TAKEOFF</code><br />
<div class="outline-text-5" id="text-8-2-2-3">
<div class="org-src-container">
<pre class="src src-sh">rosservice call /mavros/cmd/takeoff <span style="color: #DB8E73;">"{min_pitch: 0.0, yaw: 0.0, latitude: 47.3977508, longitude: 8.5456074, altitude: 2.5}"</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orge254c6c" class="outline-4">
<h4 id="orge254c6c"><span class="section-number-4">8.2.3</span> Publish</h4>
<div class="outline-text-4" id="text-8-2-3">
<div class="org-src-container">
<pre class="src src-sh">rostopic pub [topic] [msg_type] [args]
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgc51965f"></a><code>SETPOINT_POSITION</code><br />
<div class="outline-text-5" id="text-8-2-3-1">
<p>
OFFBOARD 모드에서 동작
</p>

<div class="org-src-container">
<pre class="src src-sh">rostopic pub -r 10 /mavros/setpoint_position/local geometry_msgs/PoseStamped <span style="color: #DB8E73;">"header:</span>
<span style="color: #DB8E73;">  auto</span>
<span style="color: #DB8E73;">pose:</span>
<span style="color: #DB8E73;">  position:</span>
<span style="color: #DB8E73;">    x: 5.0</span>
<span style="color: #DB8E73;">    y: 0.0</span>
<span style="color: #DB8E73;">    z: 1.0</span>
<span style="color: #DB8E73;">  orientation:</span>
<span style="color: #DB8E73;">    x: 0.0</span>
<span style="color: #DB8E73;">    y: 0.0</span>
<span style="color: #DB8E73;">    z: 0.0</span>
<span style="color: #DB8E73;">    w: 0.0"</span>
</pre>
</div>
</div>
</li>

<li><a id="orge586fa2"></a><code>SETPOINT_VELOCITY</code><br />
<div class="outline-text-5" id="text-8-2-3-2">
<p>
OFFBOARD 모드에서 동작
</p>

<div class="org-src-container">
<pre class="src src-sh">$ rostopic pub -r 10 /mavros/setpoint_velocity/cmd_vel geometry_msgs/TwistStamped <span style="color: #DB8E73;">"{header: auto, twist: {linear: {x: 10.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}}"</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org4fec7c5" class="outline-4">
<h4 id="org4fec7c5"><span class="section-number-4">8.2.4</span> 실습</h4>
<div class="outline-text-4" id="text-8-2-4">
<p>
준비: 순서대로 실행
</p>
<ul class="org-ul">
<li>Gazebo 실행: <code>cd ~/Firmware; make posix_sitl gazebo</code></li>
<li>PC의 MAVROS를 PC(127.0.0.1)의 Gazebo와 연결 <code>rosrun mavros mavros_node _fcu_url:="udp://:14540@127.0.0.1:14557" _gcs_url:="udp://@127.0.0.1"</code> <br />
또는 Raspberry PI의 MAVROS를 PC(192.168.88.53)의 Gazebo와 연결 <code>roslaunch mavros px4.launch fcu_url:="udp://:14540@192.168.88.53:14557" gcs_url:="udp://@192.168.88.53"</code></li>
<li>QGroundControl 실행: PX4 Parameter <code>COM_OF_LOSS_T</code> 파라미터 30초로 바꾸기. Failsafe timeout을 30초로 바꾸어야 커맨드라인에서 드론을 조정하기 편하다.</li>
</ul>

<p>
<br />
</p>

<p>
해보기: 커맨드 라인에서 다음 명령을 수행하여, QGroundControl에 아래와 같은 자취를 남겨보자.
</p>
<ul class="org-ul">
<li>1. ARM</li>
<li>2. TAKEOFF 하고. (옵션)</li>
<li>3. 현재 위치를 지정한다.  <code>/mavros/setpoint_position</code> 이용하여, (0,0,0) 위치를 10hz로 지정</li>
<li>3-1. MODE 변환. OFFBOARD</li>
<li>4. 20m 간격으로 정사각형을 따라 움직인다. <code>/mavros/setpoint_position</code> 이용</li>
<li>5. HOME 자리에 오면 LAND 한다.</li>
<li>6. DISARM</li>
</ul>


<div class="figure">
<p><img src="https://i.imgur.com/4IjvTca.png" alt="4IjvTca.png" />
</p>
</div>

<p>
더해보기: 드론의 머리방향이 진행 방향을 향하도록 하자.
</p>

<ul class="org-ul">
<li>Body 3-2-1 순서 오일러-&gt;쿼터니언 변환</li>
</ul>

\begin{align}
\begin{bmatrix}
x \\
y \\
z \\
w \\
\end{bmatrix}
& =
\begin{bmatrix}
\cos (\phi /2) \cos (\theta /2) \cos (\psi /2) +  \sin (\phi /2) \sin (\theta /2) \sin (\psi /2) \\
\sin (\phi /2) \cos (\theta /2) \cos (\psi /2) -  \cos (\phi /2) \sin (\theta /2) \sin (\psi /2) \\
\cos (\phi /2) \sin (\theta /2) \cos (\psi /2) +  \sin (\phi /2) \cos (\theta /2) \sin (\psi /2) \\
\cos (\phi /2) \cos (\theta /2) \sin (\psi /2) -  \sin (\phi /2) \sin (\theta /2) \cos (\psi /2) \\
\end{bmatrix} \\
\end{align}

<p>
변환 코드(python): <a href="https://gist.github.com/donghee/e3b4fa8ec789cec0e287bf3b91ddb79e">https://gist.github.com/donghee/e3b4fa8ec789cec0e287bf3b91ddb79e</a>
</p>
</div>
</div>

<div id="outline-container-org0f2154d" class="outline-4">
<h4 id="org0f2154d"><span class="section-number-4">8.2.5</span> 유용한 mavros 명령(노드) 모음</h4>
<div class="outline-text-4" id="text-8-2-5">
<p>
mavros 패키지의 mavsafety 노드: arm, disarm, safetyarea
</p>

<pre class="example">
rosrun mavros mavsafety arm
</pre>

<p>
mavcmd 노드:
</p>

<p>
예시: takeoff from current position (10도 각도 피치, 90도 방향 보고, 5m 위로 takeoff)
</p>
<pre class="example">
rosrun mavros mavcmd takeoffcur 10 90 5
</pre>

<p>
예시: home 지정(RTL 위치, 위도 35.9012382 경도 128.85449537 해발고도 71m)
google earth: <a href="https://earth.google.com/web/search/35.9012382+128.85449537">https://earth.google.com/web/search/35.9012382+128.85449537</a>
</p>
<pre class="example">
rosrun mavros mavcmd sethome 35.9012382 128.854495337 71
</pre>

<p>
mavsetp 노드: setpoint 한번 보내기 (setpoint 테스트용, position, velocity, acceleration 가능)
</p>

<p>
예시: x=1m, y=1m, z=1m, yaw=90도 setpoint 보내기
</p>
<pre class="example">
rosrun mavros mavsetp local -p 1 1 2 90
</pre>

<p>
mavsys 노드: change mode
</p>
<pre class="example">
rosrun mavros mavsys mode -c OFFBOARD
</pre>

<p>
mavparam 노드: parameter set, get, load, dump
</p>

<p>
예시: 파라미터 덤프
</p>
<pre class="example">
rosrun mavros mavparam dump /tmp/params
</pre>

<p>
mavftp 노드: px4의 파일 시스템 접근
</p>

<p>
예시: 로그 다운로드
</p>
<pre class="example">
rosrun mavros mavftp download log/2020-08-03/14_37_15.ul
</pre>
</div>
</div>
</div>




<div id="outline-container-org4c12087" class="outline-3">
<h3 id="org4c12087"><span class="section-number-3">8.3</span> 토픽 레코드: rosbag</h3>
<div class="outline-text-3" id="text-8-3">
<p>
리뷰할때 유용
</p>


<p>
토픽 저장하기
</p>
<pre class="example">
rostopic list -v
mkdir ~/bagfiles
cd ~/bagfiles
rosbag record -O iris_default_1 /mavros/local_position/pose
rosbag info iris_default_1.bag
rqt_bag
</pre>
</div>
</div>

<div id="outline-container-org2ddd5db" class="outline-3">
<h3 id="org2ddd5db"><span class="section-number-3">8.4</span> 참고</h3>
<div class="outline-text-3" id="text-8-4">
<ul class="org-ul">
<li><a href="https://github.com/mavlink/mavros/tree/master/mavros">https://github.com/mavlink/mavros/tree/master/mavros</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org41d0eb8" class="outline-2">
<h2 id="org41d0eb8"><span class="section-number-2">9</span> ROS 노드 만들기</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-org6a72cf2" class="outline-3">
<h3 id="org6a72cf2"><span class="section-number-3">9.1</span> 새로운 노드 만들기</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-orgaf9ae3d" class="outline-4">
<h4 id="orgaf9ae3d"><span class="section-number-4">9.1.1</span> 패키지 만들기</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">
<pre class="src src-sh">$ source ~/catkin_ws/devel/setup.bash
$ cd ~/catkin_ws/src
$ catkin_create_pkg drone_control mavros sensor_msgs roscpp
</pre>
</div>
</div>
</div>

<div id="outline-container-org84c12dd" class="outline-4">
<h4 id="org84c12dd"><span class="section-number-4">9.1.2</span> 노드 코드 작성</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
<code>~/catkin_ws/src/drone_control/src/drone_state.cpp</code>
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">"ros/ros.h"</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">"sensor_msgs/Imu.h"</span>

<span style="color: #35CDAF;">void</span> <span style="color: #D9DAA2;">imuDataCallback</span>(<span style="color: #339CDB;">const</span> <span style="color: #339CDB;">sensor_msgs</span>::<span style="color: #339CDB;">Imu</span>::<span style="color: #35CDAF;">ConstPtr</span>&amp; <span style="color: #85DDFF;">msg</span>){
  ROS_INFO(<span style="color: #DB8E73;">"\nlinear acceleration\</span>
<span style="color: #DB8E73;">      \nx: [%f]\ny:[%f]\nz:[%f]"</span>, msg-&gt;linear_acceleration.x,
      msg-&gt;linear_acceleration.y, msg-&gt;linear_acceleration.z);
}

<span style="color: #35CDAF;">int</span> <span style="color: #D9DAA2;">main</span>(<span style="color: #35CDAF;">int</span> <span style="color: #85DDFF;">argc</span>, <span style="color: #35CDAF;">char</span> **<span style="color: #85DDFF;">argv</span>){
  <span style="color: #339CDB;">ros</span>::init(argc, argv, <span style="color: #DB8E73;">"drone_state"</span>);
  <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">NodeHandle</span> <span style="color: #85DDFF;">nh</span>;
  <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Subscriber</span> <span style="color: #85DDFF;">sub</span> = nh.subscribe(<span style="color: #DB8E73;">"/mavros/imu/data"</span>, 1000, imuDataCallback);
  <span style="color: #339CDB;">ros</span>::spin();
  <span style="color: #339CDB;">return</span> 0;
}
</pre>
</div>

<p>
빌드 스크립트 추가
</p>

<p>
<code>~/catkin_ws/src/drone_control/CMakeLists.txt</code> 파일 끝에 다음 3줄 추가
</p>

<div class="org-src-container">
<pre class="src src-cmake">include_directories(include ${catkin_INCLUDE_DIRS})
add_executable(drone_state src/drone_state.cpp)
target_link_libraries(drone_state ${catkin_LIBRARIES})
</pre>
</div>

<p>
환경 변수 다시 로드!
</p>
<div class="org-src-container">
<pre class="src src-sh">$ source ~/catkin_ws/devel/setup.bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org70fe06c" class="outline-4">
<h4 id="org70fe06c"><span class="section-number-4">9.1.3</span> 패키지 빌드</h4>
<div class="outline-text-4" id="text-9-1-3">
<div class="org-src-container">
<pre class="src src-sh">$ cd ~/catkin_ws
$ catkin build
</pre>
</div>
</div>
</div>

<div id="outline-container-org91125e7" class="outline-4">
<h4 id="org91125e7"><span class="section-number-4">9.1.4</span> 패키지 노드 실행</h4>
<div class="outline-text-4" id="text-9-1-4">
<p>
<code>drone_control</code> 패키지의 <code>drone_state</code> 노드 실행
</p>
<div class="org-src-container">
<pre class="src src-sh">$ rosrun drone_control drone_state
</pre>
</div>
</div>
</div>


<div id="outline-container-org5a913d4" class="outline-4">
<h4 id="org5a913d4"><span class="section-number-4">9.1.5</span> 해보기: /mavros/state 읽어서 1초마다 비행 mode 한번씩 출력</h4>
<div class="outline-text-4" id="text-9-1-5">
<ul class="org-ul">
<li><code>/mavros/state</code> 타입 체크하여 헤더 include</li>
</ul>

<div class="org-src-container">
<pre class="src src-c++">
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">"ros/ros.h"</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">"mavros_msgs/State.h"</span>

<span style="color: #35CDAF;">void</span> <span style="color: #D9DAA2;">droneStateCallback</span>(<span style="color: #339CDB;">const</span> <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #339CDB;">State</span>::<span style="color: #35CDAF;">ConstPtr</span>&amp; <span style="color: #85DDFF;">msg</span>){
  ROS_INFO(<span style="color: #DB8E73;">"\nDrone mode: %s"</span>, msg-&gt;mode.c_str());
}

<span style="color: #35CDAF;">int</span> <span style="color: #D9DAA2;">main</span>(<span style="color: #35CDAF;">int</span> <span style="color: #85DDFF;">argc</span>, <span style="color: #35CDAF;">char</span> **<span style="color: #85DDFF;">argv</span>){
  <span style="color: #339CDB;">ros</span>::init(argc, argv, <span style="color: #DB8E73;">"drone_state"</span>);
  <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">NodeHandle</span> <span style="color: #85DDFF;">nh</span>;
  <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Subscriber</span> <span style="color: #85DDFF;">sub</span> = nh.subscribe(<span style="color: #DB8E73;">"/mavros/state"</span>, 1000, droneStateCallback);
  <span style="color: #339CDB;">ros</span>::spin();
  <span style="color: #339CDB;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc2a4f63" class="outline-4">
<h4 id="orgc2a4f63"><span class="section-number-4">9.1.6</span> 해보기 결과:</h4>
<div class="outline-text-4" id="text-9-1-6">
<div class="org-src-container">
<pre class="src src-c++">$ rosrun drone_control drone_state
[ INFO] [1539297808.077868114]:
Drone mode: OFFBOARD
[ INFO] [1539297808.525173697]:
Drone mode: OFFBOARD
[ INFO] [1539297809.565387356]:
Drone mode: OFFBOARD
</pre>
</div>

<p>
<code>rqt_graph</code>
</p>


<div class="figure">
<p><img src="https://i.imgur.com/CGHQVwc.png" alt="CGHQVwc.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org0d52d21" class="outline-3">
<h3 id="org0d52d21"><span class="section-number-3">9.2</span> 새로운 노드 만들기: 드론 이륙 착륙</h3>
<div class="outline-text-3" id="text-9-2">

<div class="figure">
<p><img src="mavros_takeoff_and_land1.png" alt="mavros_takeoff_and_land1.png" />
</p>
</div>

<p>
<code>drone_control</code> 패키지에 <code>takeoff_and_land</code> 노드를 만들어 보자.
</p>

<p>
2.5m 이륙후 10초 있다가 착륙
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;cstdlib&gt;</span>

<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;ros/ros.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;mavros_msgs/CommandBool.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;mavros_msgs/CommandTOL.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;mavros_msgs/SetMode.h&gt;</span>

<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;geometry_msgs/PoseStamped.h&gt;</span>

<span style="color: #35CDAF;">int</span> <span style="color: #D9DAA2;">main</span>(<span style="color: #35CDAF;">int</span> <span style="color: #85DDFF;">argc</span>, <span style="color: #35CDAF;">char</span> **<span style="color: #85DDFF;">argv</span>)
{

    <span style="color: #35CDAF;">int</span> <span style="color: #85DDFF;">rate</span> = 20;

    <span style="color: #339CDB;">ros</span>::init(argc, argv, <span style="color: #DB8E73;">"takeoff_and_land"</span>);
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">NodeHandle</span> <span style="color: #85DDFF;">n</span>;

    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Rate</span> <span style="color: #85DDFF;">r</span>(rate);

    <span style="color: #579C4C;">///////////////////</span><span style="color: #579C4C;">ARM//////////////////////</span>
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">ServiceClient</span> <span style="color: #85DDFF;">arming_client</span> = n.serviceClient&lt;<span style="color: #339CDB;">mavros_msgs</span>::CommandBool&gt;(<span style="color: #DB8E73;">"/mavros/cmd/arming"</span>);
    <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">CommandBool</span> <span style="color: #85DDFF;">arm_cmd</span>;
    arm_cmd.request.value = <span style="color: #339CDB;">true</span>;

    <span style="color: #339CDB;">if</span> (arming_client.call(arm_cmd) &amp;&amp; arm_cmd.response.success)
    {
        ROS_INFO(<span style="color: #DB8E73;">"Vehicle armed"</span>);
    } <span style="color: #339CDB;">else</span> {
        ROS_ERROR(<span style="color: #DB8E73;">"Failed arming or disarming"</span>);
    }

    <span style="color: #579C4C;">/////////////////</span><span style="color: #579C4C;">TAKEOFF////////////////////</span>
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">ServiceClient</span> <span style="color: #85DDFF;">takeoff_client</span> = n.serviceClient&lt;<span style="color: #339CDB;">mavros_msgs</span>::CommandTOL&gt;(<span style="color: #DB8E73;">"/mavros/cmd/takeoff"</span>);
    <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">CommandTOL</span> <span style="color: #85DDFF;">takeoff_cmd</span>;
    takeoff_cmd.request.altitude = 10;
    takeoff_cmd.request.latitude = 0;
    takeoff_cmd.request.longitude = 0;
    takeoff_cmd.request.min_pitch = 0;
    takeoff_cmd.request.yaw = 0;
    <span style="color: #339CDB;">if</span>(takeoff_client.call(takeoff_cmd) &amp;&amp; takeoff_cmd.response.success){
        ROS_INFO(<span style="color: #DB8E73;">"Okay Takeoff"</span>);
    }<span style="color: #339CDB;">else</span>{
        ROS_ERROR(<span style="color: #DB8E73;">"Failed Takeoff"</span>);
    }

    <span style="color: #579C4C;">/////////////////</span><span style="color: #579C4C;">DO STUFF///////////////////</span>
    sleep(10);


    <span style="color: #579C4C;">///////////////////</span><span style="color: #579C4C;">LAND/////////////////////</span>
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">ServiceClient</span> <span style="color: #85DDFF;">land_client</span> = n.serviceClient&lt;<span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">CommandTOL</span>&gt;(<span style="color: #DB8E73;">"/mavros/cmd/land"</span>);
    <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">CommandTOL</span> <span style="color: #85DDFF;">land_cmd</span>;
    land_cmd.request.altitude = 0;
    land_cmd.request.latitude = 0;
    land_cmd.request.longitude = 0;
    land_cmd.request.min_pitch = 0;
    land_cmd.request.yaw = 0;
    <span style="color: #339CDB;">if</span>(land_client.call(land_cmd) &amp;&amp; land_cmd.response.success){
        ROS_INFO(<span style="color: #DB8E73;">"Okay Land"</span>);
    }<span style="color: #339CDB;">else</span>{
        ROS_ERROR(<span style="color: #DB8E73;">"Failed Land"</span>);
    }

    <span style="color: #339CDB;">while</span> (n.ok())
    {
      <span style="color: #339CDB;">ros</span>::spinOnce();
      r.sleep();
    }

    <span style="color: #339CDB;">return</span> 0;

}
</pre>
</div>

<p>
<code>\~/catkin_ws/src/drone_control/CMakeLists.txt</code> 파일 끝에 다음 3줄 추가
</p>

<div class="org-src-container">
<pre class="src src-cmake">add_executable(takeoff_and_land src/takeoff_and_land.cpp)
target_link_libraries(takeoff_and_land ${catkin_LIBRARIES})
</pre>
</div>


<ul class="org-ul">
<li>실행: <code>rosrun drone_control takeoff_and_land</code></li>
</ul>
</div>
</div>

<div id="outline-container-org1dbc90f" class="outline-3">
<h3 id="org1dbc90f"><span class="section-number-3">9.3</span> 새로운 노드 만들기: <code>offb_node</code></h3>
<div class="outline-text-3" id="text-9-3">
<p>
<code>drone_control</code> 패키지에 <code>offb_node</code> 노드를 만들어 보자.
</p>

<p>
2m 이륙.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #579C4C;">/**</span>
<span style="color: #579C4C;"> * @file offb_node.cpp</span>
<span style="color: #579C4C;"> * @brief Offboard control example node, written with MAVROS version 0.19.x, PX4 Pro Flight</span>
<span style="color: #579C4C;"> * Stack and tested in Gazebo SITL</span>
<span style="color: #579C4C;"> */</span>

<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;ros/ros.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;geometry_msgs/PoseStamped.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;mavros_msgs/CommandBool.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;mavros_msgs/SetMode.h&gt;</span>
<span style="color: #85DDFF; font-weight: bold;">#include</span> <span style="color: #DB8E73;">&lt;mavros_msgs/State.h&gt;</span>

<span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">State</span> <span style="color: #85DDFF;">current_state</span>;
<span style="color: #35CDAF;">void</span> <span style="color: #D9DAA2;">state_cb</span>(<span style="color: #339CDB;">const</span> <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #339CDB;">State</span>::<span style="color: #35CDAF;">ConstPtr</span>&amp; <span style="color: #85DDFF;">msg</span>){
    current_state = *msg;
}

<span style="color: #35CDAF;">int</span> <span style="color: #D9DAA2;">main</span>(<span style="color: #35CDAF;">int</span> <span style="color: #85DDFF;">argc</span>, <span style="color: #35CDAF;">char</span> **<span style="color: #85DDFF;">argv</span>)
{
    <span style="color: #339CDB;">ros</span>::init(argc, argv, <span style="color: #DB8E73;">"offb_node"</span>);
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">NodeHandle</span> <span style="color: #85DDFF;">nh</span>;

    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Subscriber</span> <span style="color: #85DDFF;">state_sub</span> = nh.subscribe&lt;<span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">State</span>&gt;
            (<span style="color: #DB8E73;">"mavros/state"</span>, 10, state_cb);
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Publisher</span> <span style="color: #85DDFF;">local_pos_pub</span> = nh.advertise&lt;<span style="color: #339CDB;">geometry_msgs</span>::PoseStamped&gt;
            (<span style="color: #DB8E73;">"mavros/setpoint_position/local"</span>, 10);
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">ServiceClient</span> <span style="color: #85DDFF;">arming_client</span> = nh.serviceClient&lt;<span style="color: #339CDB;">mavros_msgs</span>::CommandBool&gt;
            (<span style="color: #DB8E73;">"mavros/cmd/arming"</span>);
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">ServiceClient</span> <span style="color: #85DDFF;">set_mode_client</span> = nh.serviceClient&lt;<span style="color: #339CDB;">mavros_msgs</span>::SetMode&gt;
            (<span style="color: #DB8E73;">"mavros/set_mode"</span>);

    <span style="color: #579C4C;">//</span><span style="color: #579C4C;">the setpoint publishing rate MUST be faster than 2Hz</span>
    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Rate</span> <span style="color: #85DDFF;">rate</span>(20.0);

    <span style="color: #579C4C;">// </span><span style="color: #579C4C;">wait for FCU connection</span>
    <span style="color: #339CDB;">while</span>(<span style="color: #339CDB;">ros</span>::ok() &amp;&amp; <span style="color: #85DDFF; font-weight: bold;">!</span>current_state.connected){
        <span style="color: #339CDB;">ros</span>::spinOnce();
        rate.sleep();
    }

    <span style="color: #339CDB;">geometry_msgs</span>::<span style="color: #35CDAF;">PoseStamped</span> <span style="color: #85DDFF;">pose</span>;
    pose.pose.position.x = 0;
    pose.pose.position.y = 0;
    pose.pose.position.z = 2;

    <span style="color: #579C4C;">//</span><span style="color: #579C4C;">send a few setpoints before starting</span>
    <span style="color: #339CDB;">for</span>(<span style="color: #35CDAF;">int</span> <span style="color: #85DDFF;">i</span> = 100; <span style="color: #339CDB;">ros</span>::ok() &amp;&amp; i &gt; 0; --i){
        local_pos_pub.publish(pose);
        <span style="color: #339CDB;">ros</span>::spinOnce();
        rate.sleep();
    }

    <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">SetMode</span> <span style="color: #85DDFF;">offb_set_mode</span>;
    offb_set_mode.request.custom_mode = <span style="color: #DB8E73;">"OFFBOARD"</span>;

    <span style="color: #339CDB;">mavros_msgs</span>::<span style="color: #35CDAF;">CommandBool</span> <span style="color: #85DDFF;">arm_cmd</span>;
    arm_cmd.request.value = <span style="color: #339CDB;">true</span>;

    <span style="color: #339CDB;">ros</span>::<span style="color: #35CDAF;">Time</span> <span style="color: #85DDFF;">last_request</span> = <span style="color: #339CDB;">ros</span>::<span style="color: #339CDB;">Time</span>::now();

    <span style="color: #339CDB;">while</span>(<span style="color: #339CDB;">ros</span>::ok()){
        <span style="color: #339CDB;">if</span>( current_state.mode != <span style="color: #DB8E73;">"OFFBOARD"</span> &amp;&amp;
            (<span style="color: #339CDB;">ros</span>::<span style="color: #339CDB;">Time</span>::now() - last_request &gt; <span style="color: #339CDB;">ros</span>::Duration(5.0))){
            <span style="color: #339CDB;">if</span>( set_mode_client.call(offb_set_mode) &amp;&amp;
                offb_set_mode.response.mode_sent){
                ROS_INFO(<span style="color: #DB8E73;">"Offboard enabled"</span>);
            }
            last_request = <span style="color: #339CDB;">ros</span>::<span style="color: #339CDB;">Time</span>::now();
        } <span style="color: #339CDB;">else</span> {
            <span style="color: #339CDB;">if</span>( <span style="color: #85DDFF; font-weight: bold;">!</span>current_state.armed &amp;&amp;
                (<span style="color: #339CDB;">ros</span>::<span style="color: #339CDB;">Time</span>::now() - last_request &gt; <span style="color: #339CDB;">ros</span>::Duration(5.0))){
                <span style="color: #339CDB;">if</span>( arming_client.call(arm_cmd) &amp;&amp;
                    arm_cmd.response.success){
                    ROS_INFO(<span style="color: #DB8E73;">"Vehicle armed"</span>);
                }
                last_request = <span style="color: #339CDB;">ros</span>::<span style="color: #339CDB;">Time</span>::now();
            }
        }

        local_pos_pub.publish(pose);

        <span style="color: #339CDB;">ros</span>::spinOnce();
        rate.sleep();
    }

    <span style="color: #339CDB;">return</span> 0;
}
</pre>
</div>

<ul class="org-ul">
<li>실행: <code>rosrun drone_control offb_node</code></li>
</ul>
</div>

<div id="outline-container-org1e9ef3a" class="outline-4">
<h4 id="org1e9ef3a"><span class="section-number-4">9.3.1</span> launch 파일을 이용하여 노드 한번에 실행 (옵션)</h4>
<div class="outline-text-4" id="text-9-3-1">
<p>
roscore, gazebo, mavros, offb<sub>node</sub> 노드를 한번에 실행하기 위해서 roslaunch를 이용해보자.
</p>

<p>
<code>~/catkin_ws/src/drone_control/launch/offb_node.launch</code> 파일에 다음 내용 추가
</p>
<pre class="example">
&lt;launch&gt;
    &lt;node name="offb_node" pkg="drone_control" type="offb_node"/&gt;
    &lt;include file="$(find px4)/launch/mavros_posix_sitl.launch"&gt;
      &lt;arg name="vehicle" value="iris"/&gt;
    &lt;/include&gt;
&lt;/launch&gt;
</pre>

<p>
<code>~/.bashrc</code> 파일의 끝에 다음 내용을 추가
환경 변수 추가
</p>
<pre class="example">
PX4_SRC_DIR=$HOME/Firmware
source $PX4_SRC_DIR/Tools/setup_gazebo.bash $PX4_SRC_DIR $PX4_SRC_DIR/build/px4_sitl_default &gt; /dev/null
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$PX4_SRC_DIR:$PX4_SRC_DIR/Tools/sitl_gazebo
</pre>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #C586C0;">source</span> ~/.bashrc
catkin build
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">roslaunch drone_control offb_node.launch
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org5489a94" class="outline-3">
<h3 id="org5489a94"><span class="section-number-3">9.4</span> 새로운 노드 만들기: <code>circle</code></h3>
<div class="outline-text-3" id="text-9-4">
<p>
출처: <a href="https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp">https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp</a>
</p>

<pre class="example">
/**
 * @file circle.cpp
 * @brief offboard example node, written with mavros version 0.14.2, px4 flight
 * stack and tested in Gazebo SITL
 */

#include &lt;ros/ros.h&gt;
#include &lt;geometry_msgs/PoseStamped.h&gt;
#include &lt;mavros_msgs/CommandBool.h&gt;
#include &lt;mavros_msgs/SetMode.h&gt;
#include &lt;mavros_msgs/State.h&gt;
#include "math.h"

double r;
double theta;
double count=0.0;
double wn;

mavros_msgs::State current_state;
void state_cb(const mavros_msgs::State::ConstPtr&amp; msg){
    current_state = *msg;
}

int main(int argc, char **argv)
{
    ros::init(argc, argv, "circle");
    ros::NodeHandle nh;

    ros::Subscriber state_sub = nh.subscribe&lt;mavros_msgs::State&gt;
            ("mavros/state", 10, state_cb);
    ros::Publisher local_pos_pub = nh.advertise&lt;geometry_msgs::PoseStamped&gt;
            ("mavros/setpoint_position/local", 10);
    ros::ServiceClient arming_client = nh.serviceClient&lt;mavros_msgs::CommandBool&gt;
            ("mavros/cmd/arming");
    ros::ServiceClient set_mode_client = nh.serviceClient&lt;mavros_msgs::SetMode&gt;
            ("mavros/set_mode");

    //the setpoint publishing rate MUST be faster than 2Hz
    ros::Rate rate(20.0);


    nh.param("pub_setpoints_traj/wn", wn, 1.0);
    nh.param("pub_setpoints_traj/r", r, 1.0);
    // wait for FCU connection
    while(ros::ok() &amp;&amp; current_state.connected){
        ros::spinOnce();
        rate.sleep();
    }

    geometry_msgs::PoseStamped pose;
    pose.pose.position.x = 0;
    pose.pose.position.y = 0;
    pose.pose.position.z = 2;

    //send a few setpoints before starting
    for(int i = 100; ros::ok() &amp;&amp; i &gt; 0; --i){
        local_pos_pub.publish(pose);
        ros::spinOnce();
        rate.sleep();
    }

    mavros_msgs::SetMode offb_set_mode;
    offb_set_mode.request.custom_mode = "OFFBOARD";

    mavros_msgs::CommandBool arm_cmd;
    arm_cmd.request.value = true;

    ros::Time last_request = ros::Time::now();

    while(ros::ok()){
        if( current_state.mode != "OFFBOARD" &amp;&amp;
            (ros::Time::now() - last_request &gt; ros::Duration(5.0))){
            if( set_mode_client.call(offb_set_mode) &amp;&amp;
                offb_set_mode.response.mode_sent){
                ROS_INFO("Offboard enabled");
            }
            last_request = ros::Time::now();
        } else {
            if( !current_state.armed &amp;&amp;
                (ros::Time::now() - last_request &gt; ros::Duration(5.0))){
                if( arming_client.call(arm_cmd) &amp;&amp;
                    arm_cmd.response.success){
                    ROS_INFO("Vehicle armed");
                }
                last_request = ros::Time::now();
            }
        }

        theta = wn*count*0.05;

        pose.pose.position.x = r*sin(theta);
        pose.pose.position.y = r*cos(theta);
        pose.pose.position.z = 2;

        count++;

        local_pos_pub.publish(pose);
        ros::spinOnce();
        rate.sleep();
    }

    return 0;
}
</pre>

<ul class="org-ul">
<li>실행: <code>rosrun drone_control circle</code></li>
</ul>
</div>
<div id="outline-container-orgf0cc9a5" class="outline-4">
<h4 id="orgf0cc9a5"><span class="section-number-4">9.4.1</span> 해보기: 원의 너비와 속도를 바꾸어 보자. 힌트 (wn, r)</h4>
</div>
</div>

<div id="outline-container-org7c0416a" class="outline-3">
<h3 id="org7c0416a"><span class="section-number-3">9.5</span> 과제: 키보드로 OFFBOARD 모드 제어하기</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li><code>offb_node</code> 코드를 참고하여, 키보드로 x,y,z 위치를 제어하여 보자.</li>
<li>참고: <a href="http://wiki.ros.org/teleop_twist_keyboard_cpp">http://wiki.ros.org/teleop_twist_keyboard_cpp</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge3ea0e3" class="outline-3">
<h3 id="orge3ea0e3"><span class="section-number-3">9.6</span> 참고</h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li><a href="https://github.com/mavlink/mavros/tree/master/mavros">https://github.com/mavlink/mavros/tree/master/mavros</a></li>
<li><a href="https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp">https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Donghee Park</p>
<p class="date">Created: 2020-08-05 Wed 11:14</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>